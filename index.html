<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kawaii Parties - Tienda</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pacifico&family=Poppins:wght@400;600&display=swap');
        
        :root {
            --primary-color: #ff69b4; /* Rosa */
            --secondary-color: #ffb6c1; /* Rosa claro */
            --accent-color: #87ceeb; /* Azul cielo */
            --background-color: #fce4ec; /* Rosa muy claro */
            --text-color: #333;
            --card-bg: #fff;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 800px;
        }

        h1 {
            font-family: 'Pacifico', cursive;
            color: var(--primary-color);
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.5em;
            font-weight: 600;
            color: var(--primary-color);
            margin-top: 40px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        /* Controles de búsqueda y filtro */
        .controls-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .controls-container input,
        .controls-container select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 1em;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        
        .card {
            background-color: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
            transition: transform 0.2s ease-in-out;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .product-list {
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .product-card {
            background-color: var(--secondary-color);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .product-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .stock-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 5px;
            padding: 5px;
            font-size: 0.8em;
            font-weight: 600;
            color: var(--text-color);
        }
        
        .out-of-stock {
            color: #dc3545;
            font-weight: bold;
        }

        .product-title {
            font-size: 1.2em;
            font-weight: 600;
            margin: 0 0 5px;
        }

        .product-price {
            font-size: 1em;
            color: #666;
            margin-bottom: 10px;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.2s;
            width: 100%;
        }

        button:hover {
            background-color: #e55a9e;
            transform: translateY(-2px);
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .cart-item-info {
            flex-grow: 1;
        }

        .cart-total {
            font-size: 1.2em;
            font-weight: 600;
            text-align: right;
            margin-top: 10px;
        }

        #checkout-form input, #checkout-form textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        #checkout-form button {
            margin-top: 10px;
        }

        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            border-radius: 10px;
            color: white;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s, visibility 0s linear 0.5s;
        }

        .message-box.show {
            opacity: 1;
            visibility: visible;
            transition-delay: 0s;
        }

        .message-box.success {
            background-color: #28a745;
        }

        .message-box.error {
            background-color: #dc3545;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s, opacity 0.5s;
        }

        .loading-overlay.visible {
            visibility: visible;
            opacity: 1;
        }

        .spinner {
            border: 8px solid var(--secondary-color);
            border-top: 8px solid var(--primary-color);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive adjustments for smaller screens */
        @media (max-width: 600px) {
            h1 {
                font-size: 2em;
            }
            body {
                padding: 10px;
            }
            .product-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Kawaii Parties</h1>
        
        <div class="message-box" id="message-box"></div>
        <div class="loading-overlay" id="loading-overlay">
            <div class="spinner"></div>
        </div>

        <section id="product-section">
            <h2 class="section-title">Productos disponibles</h2>
            
            <div class="controls-container">
                <input type="text" id="search-input" placeholder="Buscar por nombre...">
                <select id="category-filter">
                    <option value="">Todas las categorías</option>
                    <!-- Las categorías se añadirán dinámicamente aquí -->
                </select>
            </div>

            <div id="product-list" class="product-list">
                <!-- Los productos se cargarán aquí dinámicamente -->
            </div>
        </section>

        <section id="cart-section" class="card">
            <h2 class="section-title">Tu carrito</h2>
            <div id="cart-items">
                <!-- Los productos del carrito se cargarán aquí -->
                <p>El carrito está vacío.</p>
            </div>
            <div class="cart-total">
                Total: <span id="cart-total-price">$0.00</span>
            </div>
        </section>

        <section id="checkout-section" class="card">
            <h2 class="section-title">Datos del pedido</h2>
            <form id="checkout-form">
                <input type="text" id="cliente_nombre" placeholder="Tu nombre" required>
                <textarea id="direccion_envio" placeholder="Dirección de envío" required></textarea>
                <button type="submit" id="checkout-button" disabled>Realizar Pedido</button>
            </form>
        </section>
    </div>

    <script>
        // --- CONFIGURACIÓN CRÍTICA ---
        // Se ha actualizado la URL del backend con la dirección IP que proporcionaste.
        // Asegúrate de que el puerto (aquí es 5000) sea el correcto.
        const backendBaseUrl = 'http://192.168.6.109:5000'; 

        let cart = {}; 
        let allProductsData = [];
        let displayedProducts = [];

        // Elementos del DOM
        const productListEl = document.getElementById('product-list');
        const cartItemsEl = document.getElementById('cart-items');
        const cartTotalEl = document.getElementById('cart-total-price');
        const checkoutForm = document.getElementById('checkout-form');
        const checkoutButton = document.getElementById('checkout-button');
        const messageBox = document.getElementById('message-box');
        const loadingOverlay = document.getElementById('loading-overlay');
        const searchInput = document.getElementById('search-input');
        const categoryFilter = document.getElementById('category-filter');

        // Función para mostrar mensajes de éxito o error
        function showMessage(text, type) {
            messageBox.textContent = text;
            messageBox.className = `message-box show ${type}`;
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000);
        }

        // Función para mostrar el estado de carga
        function toggleLoading(show) {
            loadingOverlay.classList.toggle('visible', show);
        }

        // Cargar productos del backend
        async function fetchProducts() {
            toggleLoading(true);
            try {
                if (!backendBaseUrl || backendBaseUrl === 'AQUI_TU_URL_DEL_BACKEND') {
                    throw new Error('La URL del backend no está configurada. Por favor, añade la dirección de tu servidor local en el código.');
                }
                
                const response = await fetch(`${backendBaseUrl}/productos/`);
                
                if (!response.ok) {
                    throw new Error('Error al cargar los productos desde el servidor. Comprueba que el backend está corriendo y la URL es correcta.');
                }
                
                allProductsData = await response.json();
                populateCategories(); // Llenar el filtro de categorías
                filterAndRenderProducts(); // Mostrar los productos iniciales
            } catch (error) {
                console.error('Error:', error);
                showMessage(error.message, 'error');
            } finally {
                toggleLoading(false);
            }
        }

        // Llenar el <select> de categorías de forma dinámica
        function populateCategories() {
            const categories = [...new Set(allProductsData.map(p => p.categoria))];
            categoryFilter.innerHTML = '<option value="">Todas las categorías</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categoryFilter.appendChild(option);
            });
        }

        // Renderizar los productos en la interfaz
        function renderProducts(products) {
            productListEl.innerHTML = '';
            if (products.length === 0) {
                productListEl.innerHTML = '<p style="text-align: center; width: 100%;">No se encontraron productos.</p>';
                return;
            }

            products.forEach(product => {
                const productCardEl = document.createElement('div');
                productCardEl.className = 'product-card';
                
                const stockText = product.stock > 0 ? `Stock: ${product.stock}` : 'Sin stock';
                const stockClass = product.stock > 0 ? '' : 'out-of-stock';
                const buttonDisabled = product.stock === 0 ? 'disabled' : '';

                productCardEl.innerHTML = `
                    <img src="${product.imagen_url}" alt="${product.nombre}" class="product-image">
                    <span class="stock-info ${stockClass}">${stockText}</span>
                    <h3 class="product-title">${product.nombre}</h3>
                    <p class="product-price">$${product.precio.toFixed(2)}</p>
                    <button onclick="addToCart('${product.id}')" ${buttonDisabled}>Añadir al carrito</button>
                `;
                productListEl.appendChild(productCardEl);
            });
        }

        // Función central para filtrar y renderizar productos
        function filterAndRenderProducts() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedCategory = categoryFilter.value;
            
            displayedProducts = allProductsData.filter(product => {
                const matchesSearch = product.nombre.toLowerCase().includes(searchTerm);
                const matchesCategory = selectedCategory === '' || product.categoria === selectedCategory;
                return matchesSearch && matchesCategory;
            });

            renderProducts(displayedProducts);
        }

        // Añadir producto al carrito
        function addToCart(productId) {
            const product = allProductsData.find(p => p.id === productId);
            if (product && product.stock > 0) {
                if (cart[productId]) {
                    if (cart[productId].cantidad < product.stock) {
                        cart[productId].cantidad++;
                    } else {
                        showMessage(`No puedes añadir más unidades de ${product.nombre}, se ha alcanzado el límite de stock.`, 'error');
                        return;
                    }
                } else {
                    cart[productId] = { ...product, cantidad: 1 };
                }
                renderCart();
            } else {
                showMessage('No hay más stock disponible de este producto.', 'error');
            }
        }

        // Renderizar el carrito en la interfaz
        function renderCart() {
            cartItemsEl.innerHTML = '';
            let total = 0;
            const productIdsInCart = Object.keys(cart);

            if (productIdsInCart.length === 0) {
                cartItemsEl.innerHTML = '<p>El carrito está vacío.</p>';
                checkoutButton.disabled = true;
                cartTotalEl.textContent = '$0.00';
                return;
            }
            
            productIdsInCart.forEach(productId => {
                const item = cart[productId];
                total += item.precio * item.cantidad;
                const cartItemEl = document.createElement('div');
                cartItemEl.className = 'cart-item';
                cartItemEl.innerHTML = `
                    <div class="cart-item-info">
                        <strong>${item.nombre}</strong> x ${item.cantidad}
                    </div>
                    <span>$${(item.precio * item.cantidad).toFixed(2)}</span>
                `;
                cartItemsEl.appendChild(cartItemEl);
            });

            cartTotalEl.textContent = `$${total.toFixed(2)}`;
            checkoutButton.disabled = false;
        }

        // Manejar el envío del formulario de pedido
        checkoutForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleLoading(true);

            const pedidoData = {
                cliente_nombre: document.getElementById('cliente_nombre').value,
                direccion_envio: document.getElementById('direccion_envio').value,
                productos_en_pedido: Object.keys(cart).map(productId => ({
                    producto_id: productId,
                    cantidad: cart[productId].cantidad
                }))
            };

            // En este código, sólo simulamos el proceso.
            try {
                // Simula un envío exitoso
                await new Promise(resolve => setTimeout(resolve, 1000));

                showMessage('Pedido realizado con éxito! (Simulado)', 'success');
                cart = {}; // Vaciar el carrito
                document.getElementById('cliente_nombre').value = '';
                document.getElementById('direccion_envio').value = '';
                renderCart();
            } catch (error) {
                console.error('Error:', error);
                showMessage(error.message, 'error');
            } finally {
                toggleLoading(false);
            }
        });

        // Añadir EventListeners para la búsqueda y el filtro
        searchInput.addEventListener('input', filterAndRenderProducts);
        categoryFilter.addEventListener('change', filterAndRenderProducts);

        // Cargar los productos al iniciar la página
        document.addEventListener('DOMContentLoaded', fetchProducts);
    </script>
</body>
</html>
